import { ImageResponse } from "@vercel/og";
import { NextRequest } from "next/server";
import Masonry from "react-responsive-masonry";
import { parse } from "node-html-parser";

export const config = {
  runtime: "experimental-edge",
};

const colCount = 3;

function Col({ children }) {
  return (
    <div
      style={{
        display: "flex",
        flexDirection: "column",
        padding: "0 1rem",
        width: `${100 / colCount}%`,
        overflow: "visible",
      }}
    >
      {children}
    </div>
  );
}

function Img({ src }: { src: string }) {
  return (
    <div
      style={{
        position: "relative",
        display: "flex",
        overflow: "visible",
      }}
    >
      {/* <img
        src={src}
        style={{
          width: "100%",
          margin: "1rem 0",
          position: "absolute",
          transform: "scale(1.04)",
          opacity: 0.3,
          filter: "blur(30px)",
        }}
      /> */}
      <img
        src={src}
        style={{
          width: "100%",
          margin: "1rem 0",
          borderRadius: "5px",
        }}
      />
    </div>
  );
}

const paiLogo = (
  <svg
    width="280"
    height="95"
    viewBox="0 0 391 130"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M81.932 104C98.4629 104 111.864 90.5685 111.864 74C111.864 57.4315 98.4629 44 81.932 44C65.401 44 52 57.4315 52 74C52 90.5685 65.401 104 81.932 104Z"
      fill="white"
      fill-opacity="0.88"
    />
    <path
      fill-rule="evenodd"
      clip-rule="evenodd"
      d="M81.9337 49.2917C79.9889 49.2917 78.4122 50.8719 78.4122 52.8212V95.1742C78.4122 97.1234 79.9889 98.7035 81.9337 98.7035C83.8785 98.7035 85.455 97.1234 85.455 95.1742V52.8212C85.455 50.8719 83.8785 49.2917 81.9337 49.2917ZM64.3262 74.0022C64.3262 66.7664 68.6713 60.5476 74.889 57.8242V90.1803C68.6713 87.4569 64.3262 81.2381 64.3262 74.0022ZM99.5403 74.0022C99.5403 81.2392 95.1938 87.4587 88.9746 90.1814V57.8229C95.1938 60.5458 99.5403 66.7653 99.5403 74.0022Z"
      fill="#05020E"
    />
    <path
      d="M128.806 78.7936H136.845C138.696 78.7936 140.316 78.4214 141.705 77.6767C143.093 76.9321 144.171 75.8823 144.938 74.5272C145.718 73.1724 146.107 71.5854 146.107 69.7666V69.7301C146.107 67.9233 145.718 66.3425 144.938 64.9876C144.171 63.6326 143.093 62.5828 141.705 61.8381C140.316 61.0813 138.696 60.7029 136.845 60.7029H128.806V65.0791H135.493C137.076 65.0791 138.306 65.4819 139.183 66.2876C140.072 67.0932 140.517 68.2467 140.517 69.7482V69.785C140.517 71.2863 140.072 72.446 139.183 73.2639C138.306 74.0696 137.076 74.4725 135.493 74.4725H128.806V78.7936ZM126.048 87.125H131.565V60.7029H126.048V87.125ZM149.652 87.125H154.987V59.6042H149.652V87.125ZM164.853 87.4362C165.73 87.4362 166.54 87.3204 167.283 87.0884C168.026 86.8443 168.683 86.4963 169.256 86.0446C169.828 85.5807 170.285 85.0316 170.626 84.3967H170.9V87.125H176.18V73.4287C176.18 72.0249 175.851 70.8164 175.193 69.8032C174.535 68.7901 173.585 68.0148 172.343 67.4778C171.101 66.9406 169.597 66.6721 167.831 66.6721C166.15 66.6721 164.676 66.9224 163.41 67.4229C162.143 67.9111 161.138 68.6007 160.395 69.4919C159.664 70.3831 159.232 71.4267 159.098 72.623L159.08 72.8062H163.994L164.031 72.7147C164.226 72.1042 164.621 71.6281 165.218 71.2863C165.815 70.9323 166.6 70.7553 167.575 70.7553C168.659 70.7553 169.481 70.9994 170.041 71.4879C170.614 71.9639 170.9 72.6414 170.9 73.5202V79.8374C170.9 80.5332 170.711 81.1619 170.334 81.7233C169.968 82.2849 169.463 82.7304 168.817 83.06C168.184 83.3774 167.459 83.5361 166.643 83.5361C165.717 83.5361 164.962 83.3225 164.378 82.8952C163.805 82.4559 163.519 81.8637 163.519 81.1192V81.0824C163.519 80.3501 163.793 79.7763 164.341 79.3614C164.901 78.9341 165.736 78.6837 166.844 78.6106L173.567 78.1711V74.9118L166.058 75.3513C163.574 75.5099 161.656 76.1081 160.304 77.1457C158.964 78.1711 158.294 79.5871 158.294 81.3939V81.4121C158.294 82.6207 158.574 83.6827 159.135 84.5981C159.695 85.5014 160.468 86.2034 161.455 86.7039C162.441 87.1921 163.574 87.4362 164.853 87.4362ZM182.373 94.0829C183.981 94.0829 185.363 93.8634 186.521 93.4239C187.678 92.9966 188.664 92.2826 189.48 91.2815C190.296 90.2804 190.99 88.9194 191.563 87.1983L198.377 67.0932H192.75L188.037 84.2686L189.097 82.3826H187.653L188.749 84.2686L184.036 67.0932H178.172L185.205 87.125L185.004 87.8757C184.809 88.6203 184.444 89.1697 183.908 89.5237C183.372 89.8777 182.648 90.0547 181.734 90.0547C181.454 90.0547 181.18 90.0425 180.912 90.0181C180.656 90.0059 180.437 89.9936 180.254 89.9814V93.9731C180.571 94.0098 180.912 94.0342 181.277 94.0464C181.643 94.0707 182.008 94.0829 182.373 94.0829ZM209.047 94.1379C211.069 94.1379 212.81 93.8266 214.272 93.2041C215.746 92.5816 216.884 91.6966 217.688 90.5491C218.492 89.4138 218.894 88.0711 218.894 86.5207V67.0932H213.559V70.4075H213.34C212.987 69.6384 212.518 68.9853 211.934 68.4483C211.349 67.8989 210.667 67.4778 209.887 67.1847C209.12 66.8919 208.274 66.7454 207.348 66.7454C205.655 66.7454 204.193 67.1604 202.963 67.9904C201.745 68.8083 200.802 69.962 200.132 71.4511C199.474 72.9282 199.145 74.6739 199.145 76.688V76.7064C199.145 78.6472 199.474 80.3441 200.132 81.7966C200.789 83.2492 201.721 84.3785 202.927 85.184C204.145 85.9897 205.594 86.3926 207.275 86.3926C208.201 86.3926 209.053 86.2644 209.833 86.0081C210.612 85.7517 211.294 85.3794 211.879 84.8911C212.463 84.3907 212.938 83.7926 213.304 83.0967H213.578V86.6673C213.578 87.8268 213.188 88.7242 212.409 89.3589C211.641 90.0059 210.551 90.3294 209.138 90.3294C207.969 90.3294 207.037 90.1462 206.343 89.78C205.661 89.426 205.241 88.9683 205.083 88.4067L205.046 88.3152H199.785V88.4251C199.943 89.5481 200.4 90.5369 201.155 91.3914C201.922 92.258 202.969 92.9294 204.297 93.4055C205.625 93.8937 207.208 94.1379 209.047 94.1379ZM209.084 82.3276C208.146 82.3276 207.342 82.0957 206.672 81.6318C206.002 81.1679 205.491 80.5149 205.137 79.6726C204.784 78.8304 204.608 77.8477 204.608 76.7246V76.7064C204.608 75.5832 204.784 74.6006 205.137 73.7583C205.491 72.9161 206.002 72.263 206.672 71.7991C207.342 71.3352 208.146 71.1033 209.084 71.1033C210.021 71.1033 210.825 71.3352 211.495 71.7991C212.177 72.263 212.701 72.9161 213.066 73.7583C213.432 74.6006 213.614 75.5832 213.614 76.7064V76.7429C213.614 77.8537 213.432 78.8304 213.066 79.6726C212.701 80.5149 212.177 81.1679 211.495 81.6318C210.825 82.0957 210.021 82.3276 209.084 82.3276ZM223.042 87.125H228.376V75.9189C228.376 74.9667 228.565 74.1551 228.943 73.4836C229.332 72.8 229.881 72.2752 230.587 71.909C231.305 71.5428 232.152 71.3596 233.126 71.3596C233.54 71.3596 233.942 71.3902 234.332 71.4511C234.734 71.5001 235.112 71.5732 235.465 71.6709V67.0017C235.209 66.9284 234.917 66.8675 234.588 66.8186C234.259 66.7698 233.924 66.7454 233.583 66.7454C232.316 66.7454 231.257 67.0567 230.404 67.6792C229.552 68.3017 228.967 69.1745 228.65 70.2976H228.376V67.0932H223.042V87.125ZM246.354 87.5461C248.4 87.5461 250.161 87.1312 251.633 86.3009C253.107 85.4709 254.241 84.2746 255.032 82.7122C255.824 81.1497 256.218 79.2821 256.218 77.1091V77.0726C256.218 74.9118 255.818 73.0563 255.013 71.5061C254.222 69.9558 253.088 68.7656 251.616 67.9355C250.142 67.0932 248.387 66.6721 246.354 66.6721C244.332 66.6721 242.584 67.0932 241.11 67.9355C239.638 68.7656 238.498 69.962 237.694 71.5244C236.89 73.0747 236.489 74.924 236.489 77.0726V77.1091C236.489 79.2821 236.884 81.1497 237.676 82.7122C238.468 84.2746 239.6 85.4709 241.075 86.3009C242.56 87.1312 244.32 87.5461 246.354 87.5461ZM246.354 83.3531C245.428 83.3531 244.636 83.1089 243.978 82.6207C243.321 82.1322 242.816 81.4242 242.463 80.4965C242.122 79.5566 241.95 78.4336 241.95 77.1275V77.0907C241.95 75.7846 242.128 74.6677 242.481 73.7399C242.835 72.8122 243.34 72.1042 243.997 71.6159C244.655 71.1155 245.441 70.8652 246.354 70.8652C247.28 70.8652 248.071 71.1155 248.73 71.6159C249.386 72.1042 249.891 72.8122 250.245 73.7399C250.599 74.6677 250.774 75.7846 250.774 77.0907V77.1275C250.774 78.4336 250.599 79.5506 250.245 80.4783C249.891 81.4061 249.386 82.1201 248.73 82.6207C248.082 83.1089 247.291 83.3531 246.354 83.3531ZM266.085 87.5461C267.534 87.5461 268.758 87.2287 269.757 86.594C270.756 85.9593 271.487 85.0925 271.949 83.9939H272.224V87.125H277.558V67.0932H272.224V78.6656C272.224 79.5444 272.065 80.3195 271.749 80.9909C271.431 81.6624 270.975 82.1872 270.378 82.5657C269.781 82.9319 269.057 83.1149 268.204 83.1149C266.951 83.1149 266.036 82.7549 265.464 82.0347C264.891 81.3022 264.605 80.2402 264.605 78.8486V67.0932H259.271V80.0388C259.271 81.6258 259.526 82.9807 260.038 84.1038C260.562 85.2267 261.329 86.0814 262.339 86.6673C263.351 87.2532 264.599 87.5461 266.085 87.5461ZM281.705 87.125H287.041V75.5527C287.041 74.6495 287.198 73.8682 287.516 73.2089C287.832 72.5377 288.283 72.0189 288.867 71.6525C289.463 71.2863 290.17 71.1033 290.986 71.1033C292.228 71.1033 293.149 71.4695 293.745 72.2019C294.353 72.9221 294.658 73.9781 294.658 75.3697V87.125H299.994V74.1794C299.994 71.7869 299.403 69.9374 298.22 68.6313C297.051 67.3252 295.358 66.6721 293.143 66.6721C291.693 66.6721 290.475 66.9896 289.488 67.6242C288.515 68.2591 287.789 69.1257 287.314 70.2243H287.041V67.0932H281.705V87.125ZM311.175 87.4728C312.588 87.4728 313.811 87.1616 314.848 86.5391C315.893 85.9166 316.673 85.0559 317.186 83.9572H317.459V87.125H322.794V59.6042H317.459V70.3526H317.186C316.673 69.2416 315.888 68.3628 314.829 67.7157C313.768 67.0689 312.545 66.7454 311.157 66.7454C309.475 66.7454 308.027 67.1604 306.809 67.9904C305.602 68.8205 304.671 70.0107 304.014 71.561C303.367 73.0991 303.045 74.9424 303.045 77.0907V77.1275C303.045 79.2637 303.374 81.107 304.031 82.6572C304.689 84.1953 305.627 85.3856 306.844 86.2278C308.062 87.0579 309.507 87.4728 311.175 87.4728ZM312.982 83.0418C312.058 83.0418 311.254 82.8037 310.571 82.3276C309.901 81.8516 309.385 81.1741 309.018 80.2951C308.653 79.4041 308.47 78.3481 308.47 77.1275V77.0907C308.47 75.8701 308.653 74.8203 309.018 73.9415C309.385 73.0503 309.901 72.3667 310.571 71.8906C311.254 71.4146 312.058 71.1764 312.982 71.1764C313.897 71.1764 314.688 71.4146 315.358 71.8906C316.041 72.3667 316.57 73.0503 316.948 73.9415C317.324 74.8203 317.513 75.8701 317.513 77.0907V77.1275C317.513 78.3481 317.324 79.4041 316.948 80.2951C316.582 81.1741 316.058 81.8516 315.377 82.3276C314.707 82.8037 313.908 83.0418 312.982 83.0418Z"
      fill="#F3F2F3"
    />
  </svg>
);

export default async function handler(req: NextRequest) {
  const res = await fetch("https://playgroundai.com");

  const body = await res.text();

  const root = parse(body);

  const nextData = root.querySelector("#__NEXT_DATA__");
  const props = JSON.parse(nextData.rawText).props.pageProps;

  const urls = props.data.slice(0, 12).map((im) => {
    return im.url;
  });

  const urlsPerCol = Math.ceil(urls.length / colCount);

  const reorderedUrls = new Array(urls.length);

  for (let i in urls) {
    const colIndex = parseInt(i) % colCount;
    const rowIndex = Math.floor(parseInt(i) / colCount);
    reorderedUrls[colIndex * urlsPerCol + rowIndex] = urls[i];
  }

  const cols = [];

  for (let i = 0; i < colCount; i++) {
    const colUrls = reorderedUrls.slice(i * urlsPerCol, (i + 1) * urlsPerCol);
    cols.push(
      <Col>
        {i === colCount - 1 && <div style={{ display: "flex" }}>{paiLogo}</div>}
        {colUrls.map((url) => (
          <Img src={url} />
        ))}
      </Col>
    );
  }

  return new ImageResponse(
    (
      <div
        style={{
          fontSize: 60,
          color: "white",
          background: "#05020E",
          width: "100%",
          height: "100%",
          display: "flex",
          justifyContent: "center",
          overflow: "visible",
        }}
      >
        {cols}
      </div>
    ),
    {
      width: 1200,
      height: 630,
    }
  );
}
